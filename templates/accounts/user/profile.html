{% extends 'base/base.html' %}
{% load static %}

{% block title %}My Profile - KACAF{% endblock %}

{% block extra_css %}
<style>
    .profile-header {
        background: linear-gradient(135deg, #198754 0%, #20c997 100%);
        padding: 3rem 0;
        margin-top: -1rem;
        margin-bottom: 2rem;
    }
    .profile-avatar {
        width: 150px;
        height: 150px;
        border: 5px solid white;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }
    .badge-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 10px;
    }
    .timeline {
        position: relative;
        padding-left: 30px;
    }
    .timeline::before {
        content: '';
        position: absolute;
        left: 15px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: #dee2e6;
    }
    .timeline-item {
        position: relative;
        margin-bottom: 20px;
    }
    .timeline-item::before {
        content: '';
        position: absolute;
        left: -22px;
        top: 5px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #198754;
        border: 2px solid white;
    }
</style>
{% endblock %}

{% block content %}
<!-- Profile Header -->
<div class="profile-header text-white">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-auto">
                <div class="position-relative">
                    {% if user.profile_picture %}
                    <img src="{{ user.profile_picture.url }}" 
                         alt="{{ user.get_full_name }}" 
                         class="profile-avatar rounded-circle">
                    {% else %}
                    <div class="profile-avatar rounded-circle bg-white d-flex align-items-center justify-content-center">
                        <i class="fas fa-user fa-5x text-success"></i>
                    </div>
                    {% endif %}
                    {% if user.is_verified %}
                    <span class="position-absolute bottom-0 end-0 bg-success rounded-circle p-2 border border-3 border-white">
                        <i class="fas fa-check text-white"></i>
                    </span>
                    {% endif %}
                </div>
            </div>
            <div class="col">
                <h1 class="display-6 fw-bold">{{ user.get_full_name }}</h1>
                <p class="lead mb-2">
                    <i class="fas fa-map-marker-alt me-2"></i>
                    {{ user.village|default:"" }} 
                    {% if user.ward %}, {{ user.ward }}{% endif %}
                    {% if user.sub_county %}, {{ user.sub_county }}{% endif %}
                    , {{ user.county }}
                </p>
                <div class="d-flex flex-wrap gap-2">
                    <span class="badge bg-light text-dark">
                        <i class="fas fa-user-tag me-1"></i>
                        {{ user.get_user_type_display }}
                    </span>
                    <span class="badge bg-light text-dark">
                        <i class="fas fa-users me-1"></i>
                        {{ user.get_membership_type_display|default:"Member" }}
                    </span>
                    <span class="badge bg-light text-dark">
                        <i class="fas fa-calendar-alt me-1"></i>
                        Member since {{ user.join_date|date:"M Y" }}
                    </span>
                    {% if user.position %}
                    <span class="badge bg-warning">
                        <i class="fas fa-medal me-1"></i>
                        {{ user.position }}
                    </span>
                    {% endif %}
                </div>
            </div>
            <div class="col-auto">
                <a href="{% url 'accounts:profile_edit' %}" class="btn btn-light">
                    <i class="fas fa-edit me-2"></i>Edit Profile
                </a>
                <a href="{% url 'accounts:profile_print' %}" class="btn btn-outline-light mt-2">
                    <i class="fas fa-print me-2"></i>Print Profile
                </a>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <!-- Stats Overview -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card text-center h-100">
                <div class="card-body">
                    <div class="display-6 text-success">{{ user_trees_count }}</div>
                    <p class="text-muted mb-0">Trees Planted</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card text-center h-100">
                <div class="card-body">
                    <div class="display-6 text-success">{{ events_attended }}</div>
                    <p class="text-muted mb-0">Events Attended</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card text-center h-100">
                <div class="card-body">
                    <div class="display-6 text-success">{{ training_completed }}</div>
                    <p class="text-muted mb-0">Trainings Completed</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card text-center h-100">
                <div class="card-body">
                    <div class="display-6 text-success">{{ carbon_sequestration|floatformat:1 }}</div>
                    <p class="text-muted mb-0">Tons CO₂ Sequestered</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Content -->
    <div class="row">
        <!-- Left Column: Personal Information -->
        <div class="col-lg-4 mb-4">
            <!-- Personal Details Card -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-user-circle me-2"></i>Personal Details
                    </h6>
                </div>
                <div class="card-body">
                    <table class="table table-sm">
                        <tbody>
                            <tr>
                                <th width="40%"><i class="fas fa-envelope me-1"></i> Email</th>
                                <td>{{ user.email }}</td>
                            </tr>
                            <tr>
                                <th><i class="fas fa-phone me-1"></i> Phone</th>
                                <td>{{ user.phone|default:"Not provided" }}</td>
                            </tr>
                            <tr>
                                <th><i class="fas fa-id-card me-1"></i> ID Number</th>
                                <td>{{ user.id_number|default:"Not provided" }}</td>
                            </tr>
                            <tr>
                                <th><i class="fas fa-birthday-cake me-1"></i> Date of Birth</th>
                                <td>{{ user.date_of_birth|date:"F d, Y"|default:"Not provided" }}</td>
                            </tr>
                            <tr>
                                <th><i class="fas fa-venus-mars me-1"></i> Gender</th>
                                <td>{{ user.get_gender_display|default:"Not specified" }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Location Card -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-map-marker-alt me-2"></i>Location
                    </h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <strong>County:</strong>
                        <p class="mb-1">{{ user.county }}</p>
                    </div>
                    {% if user.sub_county %}
                    <div class="mb-3">
                        <strong>Sub-County:</strong>
                        <p class="mb-1">{{ user.sub_county }}</p>
                    </div>
                    {% endif %}
                    {% if user.ward %}
                    <div class="mb-3">
                        <strong>Ward:</strong>
                        <p class="mb-1">{{ user.ward }}</p>
                    </div>
                    {% endif %}
                    {% if user.village %}
                    <div class="mb-3">
                        <strong>Village/Area:</strong>
                        <p class="mb-1">{{ user.village }}</p>
                    </div>
                    {% endif %}
                    <div class="text-center">
                        <button class="btn btn-sm btn-outline-success" data-bs-toggle="modal" data-bs-target="#locationMapModal">
                            <i class="fas fa-map me-1"></i> View on Map
                        </button>
                    </div>
                </div>
            </div>

            <!-- Membership Status Card -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-id-card me-2"></i>Membership Status
                    </h6>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        {% if user.is_verified %}
                        <div class="display-1 text-success">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <h5 class="text-success">Active Member</h5>
                        {% else %}
                        <div class="display-1 text-warning">
                            <i class="fas fa-clock"></i>
                        </div>
                        <h5 class="text-warning">Pending Verification</h5>
                        {% endif %}
                    </div>
                    
                    <div class="progress mb-3" style="height: 10px;">
                        <div class="progress-bar bg-success" role="progressbar" 
                             style="width: {% if user.is_verified %}100{% else %}60{% endif %}%;">
                        </div>
                    </div>
                    
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            <span>Account Created</span>
                        </li>
                        <li class="mb-2">
                            <i class="fas {% if user.is_verified %}fa-check text-success{% else %}fa-clock text-warning{% endif %} me-2"></i>
                            <span>Verification</span>
                        </li>
                        <li class="mb-2">
                            <i class="fas {% if user.member_profile.completed %}fa-check text-success{% else %}fa-times text-muted{% endif %} me-2"></i>
                            <span>Profile Completion</span>
                        </li>
                        <li class="mb-2">
                            <i class="fas {% if user_trees_count > 0 %}fa-check text-success{% else %}fa-times text-muted{% endif %} me-2"></i>
                            <span>First Tree Planted</span>
                        </li>
                    </ul>
                    
                    {% if not user.is_verified %}
                    <div class="alert alert-warning">
                        <h6><i class="fas fa-info-circle me-2"></i>Action Required</h6>
                        <p class="small mb-0">Your membership is pending verification. Please complete your profile and attend orientation.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Right Column: Activity & Details -->
        <div class="col-lg-8 mb-4">
            <!-- Bio & Skills Card -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="fas fa-file-alt me-2"></i>Bio & Skills
                    </h6>
                    <button class="btn btn-sm btn-light" data-bs-toggle="collapse" data-bs-target="#bioSection">
                        <i class="fas fa-edit"></i>
                    </button>
                </div>
                <div class="card-body">
                    {% if user.bio %}
                    <div class="mb-4">
                        <h6>About Me</h6>
                        <p>{{ user.bio }}</p>
                    </div>
                    {% endif %}
                    
                    {% if user.member_profile %}
                    <div class="row">
                        {% if user.member_profile.occupation %}
                        <div class="col-md-6 mb-3">
                            <h6><i class="fas fa-briefcase me-2"></i>Occupation</h6>
                            <p class="mb-0">{{ user.member_profile.occupation }}</p>
                        </div>
                        {% endif %}
                        
                        {% if user.member_profile.education_level %}
                        <div class="col-md-6 mb-3">
                            <h6><i class="fas fa-graduation-cap me-2"></i>Education Level</h6>
                            <p class="mb-0">{{ user.member_profile.education_level }}</p>
                        </div>
                        {% endif %}
                        
                        {% if user.member_profile.farm_size %}
                        <div class="col-md-6 mb-3">
                            <h6><i class="fas fa-tractor me-2"></i>Farm Size</h6>
                            <p class="mb-0">{{ user.member_profile.farm_size }} acres</p>
                        </div>
                        {% endif %}
                        
                        {% if user.member_profile.skills %}
                        <div class="col-md-6 mb-3">
                            <h6><i class="fas fa-tools me-2"></i>Skills</h6>
                            <p class="mb-0">{{ user.member_profile.skills }}</p>
                        </div>
                        {% endif %}
                        
                        {% if user.member_profile.interests %}
                        <div class="col-12 mb-3">
                            <h6><i class="fas fa-heart me-2"></i>Interests</h6>
                            <div class="d-flex flex-wrap gap-2">
                                {% for interest in user.member_profile.interests|split:"," %}
                                <span class="badge bg-light text-dark">{{ interest.strip }}</span>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    <!-- Bio Edit Form (Collapsed) -->
                    <div class="collapse" id="bioSection">
                        <hr>
                        <form method="post" action="{% url 'accounts:profile_bio_update' %}">
                            {% csrf_token %}
                            <div class="mb-3">
                                <label class="form-label">Bio</label>
                                <textarea class="form-control" name="bio" rows="3">{{ user.bio }}</textarea>
                            </div>
                            <button type="submit" class="btn btn-success btn-sm">Update Bio</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Recent Activity Timeline -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-history me-2"></i>Recent Activity Timeline
                    </h6>
                </div>
                <div class="card-body">
                    {% if recent_activities %}
                    <div class="timeline">
                        {% for activity in recent_activities %}
                        <div class="timeline-item">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="mb-1">{{ activity.title }}</h6>
                                    <p class="mb-1 small">{{ activity.description }}</p>
                                    <small class="text-muted">
                                        <i class="fas fa-clock me-1"></i>
                                        {{ activity.timestamp|timesince }} ago
                                    </small>
                                </div>
                                <div>
                                    {% if activity.type == 'tree_planting' %}
                                    <span class="badge bg-success">Tree</span>
                                    {% elif activity.type == 'event' %}
                                    <span class="badge bg-info">Event</span>
                                    {% elif activity.type == 'training' %}
                                    <span class="badge bg-warning">Training</span>
                                    {% elif activity.type == 'achievement' %}
                                    <span class="badge bg-purple">Achievement</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No recent activities found.</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Achievements & Badges -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-trophy me-2"></i>Achievements & Badges
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for badge in badges %}
                        <div class="col-md-4 mb-3">
                            <div class="card border-0 shadow-sm text-center h-100">
                                <div class="card-body">
                                    <div class="badge-icon mx-auto mb-3" 
                                         style="background-color: {{ badge.color }};">
                                        <i class="{{ badge.icon }} fa-2x text-white"></i>
                                    </div>
                                    <h6>{{ badge.name }}</h6>
                                    <p class="small text-muted mb-0">{{ badge.description }}</p>
                                    <small class="text-muted">
                                        <i class="fas fa-calendar-alt me-1"></i>
                                        {{ badge.date_earned|date:"M Y" }}
                                    </small>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="col-12 text-center py-4">
                            <i class="fas fa-award fa-3x text-muted mb-3"></i>
                            <p class="text-muted">No badges earned yet.</p>
                            <p class="small">Participate in events and plant trees to earn badges!</p>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <!-- Progress towards next level -->
                    <div class="mt-4">
                        <h6>Progress to Next Level</h6>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar bg-success progress-bar-striped" 
                                 role="progressbar" 
                                 style="width: {{ level_progress }}%;"
                                 aria-valuenow="{{ level_progress }}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                                Level {{ user_level }}
                            </div>
                        </div>
                        <div class="d-flex justify-content-between mt-2">
                            <small>Level {{ user_level }}</small>
                            <small>{{ points_needed }} points to Level {{ user_level|add:1 }}</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- My Trees Summary -->
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-tree me-2"></i>My Trees Summary
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <canvas id="treeSpeciesChart" width="400" height="200"></canvas>
                        </div>
                        <div class="col-md-6 mb-3">
                            <canvas id="treeStatusChart" width="400" height="200"></canvas>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Species</th>
                                    <th>Count</th>
                                    <th>Survival Rate</th>
                                    <th>Carbon Sequestered</th>
                                    <th>Last Monitored</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for tree_stat in tree_stats %}
                                <tr>
                                    <td>{{ tree_stat.species }}</td>
                                    <td>{{ tree_stat.count }}</td>
                                    <td>
                                        <div class="progress" style="height: 10px;">
                                            <div class="progress-bar {% if tree_stat.survival_rate >= 80 %}bg-success{% elif tree_stat.survival_rate >= 50 %}bg-warning{% else %}bg-danger{% endif %}" 
                                                 role="progressbar" 
                                                 style="width: {{ tree_stat.survival_rate }}%;">
                                            </div>
                                        </div>
                                        <small>{{ tree_stat.survival_rate }}%</small>
                                    </td>
                                    <td>{{ tree_stat.carbon|floatformat:2 }} tons</td>
                                    <td>{{ tree_stat.last_monitored|date:"M d, Y" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Location Map Modal -->
<div class="modal fade" id="locationMapModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">Location Map</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="locationMap" style="height: 400px;"></div>
                <div class="mt-3">
                    <p><strong>Address:</strong> {{ user.village }}, {{ user.ward }}, {{ user.sub_county }}, {{ user.county }}</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Leaflet for Maps -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

<script>
    // Tree Species Chart
    const speciesCtx = document.getElementById('treeSpeciesChart').getContext('2d');
    const speciesChart = new Chart(speciesCtx, {
        type: 'doughnut',
        data: {
            labels: {{ tree_species_labels|safe }},
            datasets: [{
                data: {{ tree_species_data|safe }},
                backgroundColor: [
                    '#198754', '#20c997', '#0dcaf0', '#ffc107', '#fd7e14',
                    '#dc3545', '#6f42c1', '#e83e8c', '#20c997', '#198754'
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'right',
                },
                title: {
                    display: true,
                    text: 'Trees by Species'
                }
            }
        }
    });
    
    // Tree Status Chart
    const statusCtx = document.getElementById('treeStatusChart').getContext('2d');
    const statusChart = new Chart(statusCtx, {
        type: 'bar',
        data: {
            labels: ['Healthy', 'Needs Care', 'Replant'],
            datasets: [{
                label: 'Trees',
                data: {{ tree_status_data|safe }},
                backgroundColor: ['#198754', '#ffc107', '#dc3545']
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Tree Health Status'
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    
    // Initialize Map
    document.getElementById('locationMapModal').addEventListener('shown.bs.modal', function () {
        // Initialize map centered on West Pokot
        const map = L.map('locationMap').setView([1.9167, 35.1667], 10);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);
        
        // Add marker for user location (using approximate coordinates)
        L.marker([1.9167, 35.1667])
            .addTo(map)
            .bindPopup('{{ user.village }}, {{ user.county }}')
            .openPopup();
    });
</script>
{% endblock %}